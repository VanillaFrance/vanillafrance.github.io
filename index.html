<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOSUM Interactive Simulation - Pro Version</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f0f2f5; color: #1a1a1b; }
        .main-container { display: flex; gap: 20px; max-width: 1400px; margin: auto; }
        .left-panel { flex: 3; }
        .right-panel { flex: 1; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 15px; display: flex; flex-direction: column; }
        
        /* 调整网格以容纳更多控件 */
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .control-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #444; }
        
        #plot { height: 600px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        #dataWindow { flex-grow: 1; font-family: 'Courier New', Courier, monospace; font-size: 12px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fafafa; border-radius: 4px; max-height: 500px; }
        .data-row { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid #eee; }
        .current-row { background: #fff3cd; font-weight: bold; }

        .greek-math { font-family: "Times New Roman", Times, serif; font-style: italic; font-size: 1.1em; }
        .footer-note { margin-top: 20px; padding: 15px; background: #e9ecef; border-left: 5px solid #007bff; font-size: 0.95em; line-height: 1.6; }
    </style>
</head>
<body>

    <h2 style="text-align: center;">MOSUM Change-Point Detection Simulator</h2>
    
    <div class="main-container">
        <div class="left-panel">
            <div class="controls">
                <div class="control-group">
                    <label>Bandwidth (<span class="greek-math">G</span>): <span id="gVal">40</span></label>
                    <input type="range" id="paramG" min="10" max="100" value="40">
                </div>
                <div class="control-group">
                    <label>Noise Level (<span class="greek-math">&sigma;</span>): <span id="noiseVal">1.0</span></label>
                    <input type="range" id="paramNoise" min="0.1" max="3" step="0.1" value="1.0">
                </div>
                <div class="control-group">
                    <label>Threshold (<span class="greek-math">&tau;</span>): <span id="threshVal">3.5</span></label>
                    <input type="range" id="paramThresh" min="1" max="10" step="0.1" value="3.5">
                </div>
                <div class="control-group">
                    <label><span class="greek-math">&eta;</span>-Criterion: <span id="etaVal">0.4</span></label>
                    <input type="range" id="paramEta" min="0" max="1" step="0.1" value="0.4">
                </div>
                <div class="control-group">
                    <label><span class="greek-math">&epsilon;</span>-Criterion: <span id="epsVal">0.2</span></label>
                    <input type="range" id="paramEps" min="0" max="1" step="0.1" value="0.2">
                </div>
                <div class="control-group">
                    <label>Speed: <span id="speedVal">1x</span></label>
                    <input type="range" id="paramSpeed" min="1" max="5" value="1">
                </div>
                <button onclick="resetAnimation()" style="grid-column: span 3; padding: 12px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold;">Reset Simulation Data</button>
            </div>

            <div id="plot"></div>
        </div>

        <div class="right-panel">
            <label>Raw Data Stream (<span class="greek-math">X<sub>t</sub></span>)</label>
            <div id="dataWindow"></div>
            <p style="font-size: 11px; color: #777; margin-top: 10px;">Window lists: Index | Value</p>
        </div>
    </div>

<style>
    .footer-note {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        padding: 15px;
        background-color: #f9f9f9;
        border-left: 4px solid #005a9c;
        font-size: 14px;
    }

    .greek-math {
        font-family: "Cambria Math", "Times New Roman", serif;
        font-style: italic;
        font-weight: bold;
        color: #d32f2f; /* Distinct color for variables */
    }

    .concept-highlight {
        color: #005a9c;
        font-weight: 500;
    }
</style>

<div class="footer-note">
    <span class="concept-highlight"><strong>Mathematical Logic:</strong></span> 
    The detector <span class="greek-math">|T<sub>G</sub>(k)|</span> is calculated by the normalized difference of the right and left window means. 
    
    <span class="concept-highlight">The stability</span> is governed by the 
    <span class="greek-math">&eta;</span>-criterion (local dominance to avoid redundant detections) and 
    <span class="greek-math">&epsilon;</span>-criterion (minimum duration to filter short noise spikes), 
    
    <span class="concept-highlight">ensuring</span> that 
    <span class="greek-math">&sigma;</span> fluctuations do not trigger false positives.
</div>


    <script>
        const N = 500;
        const jumpLoc = 250;
        let currentIndex = 40;
        let dataX = [];
        let mosumCurve = Array(N).fill(null);

        function generateData() {
            const noise = parseFloat(document.getElementById('paramNoise').value);
            dataX = [];
            for (let i = 0; i < N; i++) {
                const mu = (i < jumpLoc) ? 0 : 1; // 增加跳跃幅度以使波峰更明显
                const u1 = Math.random();
                const u2 = Math.random();
                const randStdNormal = Math.sqrt(-2.0 * Math.log(u1)) * Math.sin(2.0 * Math.PI * u2);
                dataX.push(parseFloat((mu + randStdNormal * noise).toFixed(3)));
            }
            updateDataWindow();
        }

        function updateDataWindow() {
            const container = document.getElementById('dataWindow');
            container.innerHTML = dataX.map((val, i) => `
                <div class="data-row" id="row-${i}">
                    <span>t = ${i}</span>
                    <span>${val}</span>
                </div>
            `).join('');
        }

        function calculateMOSUM(k, G) {
            if (k < G || k > N - G) return 0;
            let leftSum = 0, rightSum = 0;
            for (let i = k - G; i < k; i++) leftSum += dataX[i];
            for (let i = k; i < k + G; i++) rightSum += dataX[i];
            return Math.abs(Math.sqrt(G / 2) * ((rightSum / G) - (leftSum / G)));
        }

        function resetAnimation() {
            const G = parseInt(document.getElementById('paramG').value);
            currentIndex = G;
            generateData();
        }

        function update() {
            const G = parseInt(document.getElementById('paramG').value);
            const noise = parseFloat(document.getElementById('paramNoise').value);
            const threshold = parseFloat(document.getElementById('paramThresh').value);
            const speed = parseInt(document.getElementById('paramSpeed').value);
            const eta = parseFloat(document.getElementById('paramEta').value);
            const eps = parseFloat(document.getElementById('paramEps').value);

            document.getElementById('gVal').innerText = G;
            document.getElementById('noiseVal').innerText = noise.toFixed(1);
            document.getElementById('threshVal').innerText = threshold.toFixed(1);
            document.getElementById('etaVal').innerText = eta.toFixed(1);
            document.getElementById('epsVal').innerText = eps.toFixed(1);
            document.getElementById('speedVal').innerText = speed + 'x';

            for (let i = G; i < N - G; i++) mosumCurve[i] = calculateMOSUM(i, G);

            document.querySelectorAll('.current-row').forEach(el => el.classList.remove('current-row'));
            const currentRow = document.getElementById(`row-${currentIndex}`);
            if (currentRow) {
                currentRow.classList.add('current-row');
                currentRow.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }

            const traces = [
                { x: Array.from({length: N}, (_, i) => i), y: dataX, mode: 'lines', name: 'Raw Data', line: {color: '#bdc3c7', width: 1}, xaxis: 'x', yaxis: 'y' },
                { x: [currentIndex - G, currentIndex], y: [dataX[currentIndex-G], dataX[currentIndex]], mode: 'none', fill: 'tozeroy', fillcolor: 'rgba(231, 76, 60, 0.3)', name: 'Left', xaxis: 'x', yaxis: 'y' },
                { x: [currentIndex, currentIndex + G], y: [dataX[currentIndex], dataX[currentIndex+G]], mode: 'none', fill: 'tozeroy', fillcolor: 'rgba(52, 152, 219, 0.3)', name: 'Right', xaxis: 'x', yaxis: 'y' },
                
                { x: Array.from({length: N}, (_, i) => i), y: mosumCurve, mode: 'lines', name: 'MOSUM', line: {color: '#2c3e50', width: 2}, xaxis: 'x', yaxis: 'y2' },
                { x: [0, N], y: [threshold, threshold], mode: 'lines', line: {dash: 'dash', color: '#e74c3c'}, name: 'Threshold', xaxis: 'x', yaxis: 'y2' },
                { x: [currentIndex], y: [mosumCurve[currentIndex]], mode: 'markers', marker: {size: 12, color: '#f1c40f', symbol: 'diamond'}, xaxis: 'x', yaxis: 'y2' }
            ];

            const layout = {
                showlegend: false,
                grid: {rows: 2, columns: 1, pattern: 'independent'},
                xaxis: {title: 'Time index (k)', gridcolor: '#eee'},
                yaxis: {title: 'Signal Amplitude', range: [-5, 5]},
                yaxis2: {title: 'Detector |T_G(k)|', range: [0, 8], gridcolor: '#eee'},
                margin: {t: 20, b: 40, l: 60, r: 20},
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.react('plot', traces, layout);

            currentIndex += speed;
            if (currentIndex >= N - G) currentIndex = G;
            
            setTimeout(() => requestAnimationFrame(update), 60);
        }

        generateData();
        update();
    </script>
</body>
</html>
