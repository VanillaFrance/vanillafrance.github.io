<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Robot DH Visualization with XYZ Labels</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #222; }
        #container { width: 100vw; height: 100vh; }
        
        /* UI Panel Styling */
        #ui-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 320px;
            color: white;
            background: rgba(40, 40, 40, 0.9);
            backdrop-filter: blur(8px);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 10;
        }
        h2 { margin-top: 0; font-size: 18px; border-bottom: 2px solid #00d2ff; padding-bottom: 10px; color: #fff; }
        .control-group { margin-bottom: 18px; }
        label { display: block; font-size: 14px; margin-bottom: 8px; color: #ddd; font-weight: 600; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #00d2ff; }
        .value-display { float: right; font-family: monospace; color: #00d2ff; }
        
        .btn-anim {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .btn-anim:hover { background-color: #0056b3; }

        /* General Labels */
        .label {
            position: absolute;
            font-family: 'Segoe UI', sans-serif;
            font-weight: bold;
            pointer-events: none;
            user-select: none;
            white-space: nowrap;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000;
        }
        
        /* Main Frame Labels (Z0, Z1...) */
        .label-main {
            color: #ffffff;
            font-size: 16px; 
            z-index: 5;
        }

        /* Alpha Labels (Yellow) */
        .label-alpha { 
            color: #ffff00; 
            font-style: italic; 
            font-size: 13px; 
            z-index: 4;
        }
        
        /* Axis Tip Labels (Small X, Y, Z) */
        .label-axis {
            font-size: 12px;
            font-family: monospace;
            z-index: 3;
            opacity: 0.9;
        }

        .legend-item { display: flex; align-items: center; margin-bottom: 6px; font-size: 13px; color: #ccc; }
        .color-box { width: 12px; height: 12px; margin-right: 8px; border-radius: 2px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

<div id="container"></div>

<div id="ui-panel">
    <h2>DH Visualization + XYZ</h2>
    
    <div class="control-group">
        <label>θ₁ (Base Rotation) <span id="val-t1" class="value-display">0°</span></label>
        <input type="range" id="slider-t1" min="-180" max="180" value="0" step="1">
    </div>

    <div class="control-group">
        <label>θ₂ (Arm Pitch) <span id="val-t2" class="value-display">0°</span></label>
        <input type="range" id="slider-t2" min="-90" max="90" value="0" step="1">
    </div>

    <div class="control-group">
        <label>d₃ (Arm Extension) <span id="val-d3" class="value-display">1.00</span></label>
        <input type="range" id="slider-d3" min="0" max="2.0" value="1.0" step="0.05">
    </div>

    <button id="btn-animate" class="btn-anim">Auto Animation: OFF</button>
    
    <div style="margin-top:20px; border-top: 1px solid #555; padding-top: 10px;">
        <div class="legend-item"><div class="color-box" style="background:#ff3333"></div>X Axis</div>
        <div class="legend-item"><div class="color-box" style="background:#33cc33"></div>Y Axis</div>
        <div class="legend-item"><div class="color-box" style="background:#5555ff"></div>Z Axis</div>
        <div class="legend-item"><div class="color-box" style="background:#ffff00"></div>Twist (α)</div>
    </div>
</div>

<script>
    // --- 1. Scene Setup ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x2a2a2a);
    
    const gridHelper = new THREE.GridHelper(20, 20, 0x555555, 0x333333);
    scene.add(gridHelper);
    
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(12, 10, 15); 
    camera.lookAt(0, 3, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.getElementById('container').appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    const ambientLight = new THREE.AmbientLight(0x888888);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
    dirLight.position.set(5, 15, 10);
    dirLight.castShadow = true;
    scene.add(dirLight);

    // --- 2. Helper Functions ---

    const labels = [];
    
    /**
     * Creates a text label overlay
     * @param {string} text - The content
     * @param {string} type - 'main' (white/large), 'alpha' (yellow), 'axis' (small colored)
     * @param {string} color - CSS color string (only for 'axis' type usually)
     */
    function createLabel(text, type='main', color='#ffffff') {
        const div = document.createElement('div');
        
        if (type === 'alpha') {
            div.className = 'label label-alpha';
        } else if (type === 'axis') {
            div.className = 'label label-axis';
            div.style.color = color;
        } else {
            div.className = 'label label-main';
        }
        
        div.innerHTML = text; 
        document.body.appendChild(div);
        
        const labelObj = { div: div, obj: null, offset: new THREE.Vector3(0,0,0) };
        labels.push(labelObj);
        return labelObj;
    }

    // Updated createFrame to include X, Y, Z labels automatically
    function createFrame(scale=1.0) {
        const group = new THREE.Group();
        
        // --- X Axis (Red) ---
        group.add(new THREE.ArrowHelper(new THREE.Vector3(1,0,0), new THREE.Vector3(0,0,0), scale, 0xff3333, 0.2*scale, 0.15*scale));
        const lblX = createLabel("x", 'axis', '#ff5555');
        lblX.obj = group;
        lblX.offset.set(scale + 0.15, 0, 0);

        // --- Y Axis (Green) ---
        group.add(new THREE.ArrowHelper(new THREE.Vector3(0,1,0), new THREE.Vector3(0,0,0), scale, 0x33cc33, 0.2*scale, 0.15*scale));
        const lblY = createLabel("y", 'axis', '#55ff55');
        lblY.obj = group;
        lblY.offset.set(0, scale + 0.15, 0);

        // --- Z Axis (Blue) ---
        group.add(new THREE.ArrowHelper(new THREE.Vector3(0,0,1), new THREE.Vector3(0,0,0), scale, 0x5555ff, 0.2*scale, 0.15*scale));
        const lblZ = createLabel("z", 'axis', '#8888ff');
        lblZ.obj = group;
        lblZ.offset.set(0, 0, scale + 0.15);

        return group;
    }

    function createTwistArc(radius=1.0) {
        const geometry = new THREE.TorusGeometry(radius, 0.03, 8, 40, Math.PI/2);
        const material = new THREE.MeshBasicMaterial({ color: 0xffff00 });
        const mesh = new THREE.Mesh(geometry, material);
        const coneGeo = new THREE.ConeGeometry(0.08, 0.2, 16);
        const coneMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
        const cone = new THREE.Mesh(coneGeo, coneMat);
        cone.position.set(-radius, 0, 0); 
        cone.rotation.z = -Math.PI/2 - Math.PI; 
        
        const container = new THREE.Group();
        mesh.rotation.z = Math.PI/2; 
        mesh.position.set(0,0,0);
        cone.position.set(radius, 0, 0);
        cone.rotation.z = -Math.PI/2;
        container.add(mesh);
        container.add(cone);
        return container;
    }

    // --- 3. Robot Construction ---

    const L1 = 2.0; 
    const L2 = 1.0; 
    const L3 = 1.0; 

    const robotRoot = new THREE.Group();
    scene.add(robotRoot);

    // === FRAME 0: BASE ===
    const baseGroup = new THREE.Group();
    robotRoot.add(baseGroup);

    // Visual Base
    const baseMesh = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 1.0, 0.2, 32), new THREE.MeshPhongMaterial({color:0x333333}));
    baseMesh.position.y = 0.1;
    baseGroup.add(baseMesh);

    // FRAME 0
    // Rotate standard frame (-90 around X) so its Z points Up
    const frame0 = createFrame(1.5);
    frame0.rotation.x = -Math.PI/2; 
    baseGroup.add(frame0);
    
    // Add Main Label for Frame 0
    const lblF0 = createLabel("Frame 0");
    lblF0.obj = frame0;
    lblF0.offset.set(0.5, 0.5, 0.5); 

    // === LINK 1 (Static) ===
    const link1Mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, L1, 16), new THREE.MeshPhongMaterial({color:0xffaa00}));
    link1Mesh.position.y = L1/2; 
    baseGroup.add(link1Mesh);

    // === JOINT 1 NODE ===
    const joint1Node = new THREE.Group();
    joint1Node.position.y = L1; 
    baseGroup.add(joint1Node);

    // FRAME 1
    // Z1 is VERTICAL (Parallel to Z0)
    const frame1 = createFrame(1.3);
    frame1.rotation.x = -Math.PI/2; 
    joint1Node.add(frame1);

    const lblF1 = createLabel("Frame 1");
    lblF1.obj = frame1;
    lblF1.offset.set(0.5, 0.5, 0.5);

    // === LINK 2 ===
    const link2Mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.18, 0.18, L2, 16), new THREE.MeshPhongMaterial({color:0x007bff}));
    link2Mesh.position.y = L2/2; 
    joint1Node.add(link2Mesh);

    // === FRAME 2 (Twist Location) ===
    const twistNode = new THREE.Group();
    twistNode.position.y = L2;
    joint1Node.add(twistNode);

    // VISUAL ARC 1 (alpha = 90)
    const arc1 = createTwistArc(0.8);
    twistNode.add(arc1);
    const lblAlpha1 = createLabel("α₁=90°", 'alpha');
    lblAlpha1.obj = twistNode;
    lblAlpha1.offset.set(0.6, 0.6, 0);

    // FRAME 2
    // Z2 is Horizontal. Rotate standard frame so Z points along X.
    const frame2 = createFrame(1.3);
    frame2.rotation.y = Math.PI/2; 
    twistNode.add(frame2);

    const lblF2 = createLabel("Frame 2");
    lblF2.obj = frame2;
    lblF2.offset.set(0.5, 0.5, 0.5);

    // === JOINT 2 NODE ===
    const joint2Node = new THREE.Group();
    frame2.add(joint2Node); 

    // === LINK 3 (The Arm) ===
    const armHousing = new THREE.Group();
    joint2Node.add(armHousing);

    const housingMesh = new THREE.Mesh(new THREE.BoxGeometry(L3, 0.3, 0.3), new THREE.MeshPhongMaterial({color:0xff3333}));
    housingMesh.position.x = L3/2; 
    armHousing.add(housingMesh);

    // === PRISMATIC JOINT (d3) ===
    const sliderGroup = new THREE.Group();
    armHousing.add(sliderGroup);

    const sliderMesh = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.25, 0.25), new THREE.MeshPhongMaterial({color:0xdddddd}));
    sliderGroup.add(sliderMesh);

    // === FRAME 3 (End Effector) ===
    // Twist Z -90 around X.
    const frame3 = createFrame(1.0);
    frame3.rotation.x = -Math.PI/2; 
    sliderGroup.add(frame3);

    const lblF3 = createLabel("Frame 3");
    lblF3.obj = frame3;
    lblF3.offset.set(0.5, 0.5, 0.5);

    // VISUAL ARC 2 (alpha = -90)
    const arc2 = createTwistArc(0.6);
    arc2.rotation.y = Math.PI/2; 
    arc2.rotation.x = Math.PI/2;
    sliderGroup.add(arc2);
    
    const lblAlpha2 = createLabel("α₂=-90°", 'alpha');
    lblAlpha2.obj = sliderGroup;
    lblAlpha2.offset.set(0.5, -0.5, 0);


    // --- 4. Animation Loop ---

    const state = { t1: 0, t2: 0, d3: 1.0, auto: false, time: 0 };

    function updatePhysics() {
        // Joint 1 Rotation
        joint1Node.rotation.y = THREE.MathUtils.degToRad(state.t1);

        // Joint 2 Rotation
        joint2Node.rotation.z = THREE.MathUtils.degToRad(state.t2);

        // Joint 3 Extension
        sliderGroup.position.x = (L3/2) + parseFloat(state.d3); 
        
        // Update Labels
        labels.forEach(item => {
            const pos = new THREE.Vector3();
            // Important: We need to handle the nested transforms correctly
            item.obj.getWorldPosition(pos);
            
            // Get local offset rotated into world space
            const quat = new THREE.Quaternion();
            item.obj.getWorldQuaternion(quat);
            const worldOffset = item.offset.clone().applyQuaternion(quat);
            pos.add(worldOffset);
            
            pos.project(camera);
            
            const x = (pos.x * 0.5 + 0.5) * window.innerWidth;
            const y = (-(pos.y * 0.5) + 0.5) * window.innerHeight;
            
            if (pos.z < 1) {
                item.div.style.left = x + 'px';
                item.div.style.top = y + 'px';
                item.div.style.display = 'block';
            } else {
                item.div.style.display = 'none';
            }
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();

        if (state.auto) {
            state.time += 0.02;
            state.t1 = Math.sin(state.time * 0.5) * 45;
            state.t2 = Math.sin(state.time * 0.8) * 30;
            state.d3 = 1.0 + Math.sin(state.time * 1.0) * 0.5;
            
            document.getElementById('slider-t1').value = state.t1;
            document.getElementById('slider-t2').value = state.t2;
            document.getElementById('slider-d3').value = state.d3;
        }
        
        document.getElementById('val-t1').innerText = parseFloat(state.t1).toFixed(0) + "°";
        document.getElementById('val-t2').innerText = parseFloat(state.t2).toFixed(0) + "°";
        document.getElementById('val-d3').innerText = parseFloat(state.d3).toFixed(2);

        updatePhysics();
        renderer.render(scene, camera);
    }

    document.getElementById('slider-t1').addEventListener('input', (e) => { state.t1 = e.target.value; state.auto=false; });
    document.getElementById('slider-t2').addEventListener('input', (e) => { state.t2 = e.target.value; state.auto=false; });
    document.getElementById('slider-d3').addEventListener('input', (e) => { state.d3 = e.target.value; state.auto=false; });
    document.getElementById('btn-animate').addEventListener('click', (e) => { 
        state.auto = !state.auto; 
        e.target.innerText = state.auto ? "Auto Animation: ON" : "Auto Animation: OFF";
    });

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();

</script>
</body>
</html>
